<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      html {
        font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
      }
      .longbox {
        width: 18rem;
      }
      .shortbox {
        width: 4rem;
      }
      table caption, .remark {
        font-size: 70%;
      }
      td .switch {
        vertical-align: middle;
      }
      iframe {
        width: 100%;
        height: 100vh;
        height: 100dvh;
        border: none;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 28px;
        height: 16px;
      }
      .switch input { 
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: .4s;
        transition: .4s;
        border-radius: 16px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 12px;
        width: 12px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #2196F3;
      }
      input:focus + .slider {
        box-shadow: 0 0 1px #2196F3;
      }
      input:checked + .slider:before {
        -webkit-transform: translateX(12px);
        -ms-transform: translateX(12px);
        transform: translateX(12px);
      }
    </style>
  </head>
  <body>
    <h3>中野バプテスト教会　蔵書検索サービス</h3>
    <form>
      <table>
      <caption>キーワードはスペースで区切ってください。</caption>
        <tr><td></td><td><input class="longbox" type="search" name="keyword" placeholder="キーワード"></td><td><label class="switch"><input type="checkbox" name="keywordOr" checked><span class="slider"></span></label>OR</td></tr>
        <tr><td>タイトル</td><td><input class="longbox" type="search" name="title"></td><td><label class="switch"><input type="checkbox" name="titleOr"><span class="slider"></span></label>OR</td></tr>
        <tr><td>著者・編者</td><td><input class="longbox" type="search" name="author"></td><td><label class="switch"><input type="checkbox" name="authorOr"><span class="slider"></span></label>OR</td></tr>
        <tr><td>出版者</td><td><input class="longbox" type="search" name="publisher" placeholder="出版社名など"></td><td><label class="switch"><input type="checkbox" name="publisherOr"><span class="slider"></span></label>OR</td></tr>
        <tr><td>出版年</td><td><input class="shortbox" type="search" name="yearfrom" placeholder="西暦">-<input class="shortbox" type="search" name="yearuntil" placeholder="西暦"></td><td></td></tr>
        <tr><td></td><td><button onclick="sendQuery(event)">検索</button></td><td><span class="remark">Powered by <a href="https://docs.google.com/spreadsheets/d/1-XgySBso-vJoqMhmYgUZMtjcCY0qnjm-vIr3c6J7_M8/edit?usp=sharing">Google Sheets</a></span></td></tr>
      </table>
    </form>
    <iframe id='results'></iframe>
    <script>
      function sendQuery(event) {
        // change here! if column or sheet names are modified in the sheet
        const selectA1 = {'著者・編者':'B', '読み':'C', 'シリーズ名':'D', '巻号':'E', 'タイトル':'F', '出版者':'G', '出版年':'H', '分類記号':'I', '配架場所':'L'};
        const yomiIndex = 1;
        const authorIndices = [0, yomiIndex];
        const titleIndices = [2, 4];
        const publisherIndex = 5;
        const publishyearIndex = 6;
        const sheetname = 'Sheet1';
        //
        const regex = /["'=\[\]・　＝]/g;
        const interItemOperator = ' and ';
        var select = Object.keys(selectA1);
        var keywords = document.querySelector('input[name="keyword"]').value.replace(regex, ' ').split(' ');
        var keywordOperator = document.querySelector('input[name="keywordOr"]').checked ? ' or ' : ' and ';
        var titles = document.querySelector('input[name="title"]').value.replace(regex, ' ').split(' ');
        var titleOperator = document.querySelector('input[name="titleOr"]').checked ? ' or ' : ' and ';
        var authors = document.querySelector('input[name="author"]').value.replace(regex, ' ').split(' ');
        var authorOperator = document.querySelector('input[name="authorOr"]').checked ? ' or ' : ' and ';
        var publishers = document.querySelector('input[name="publisher"]').value.replace(regex, ' ').split(' ');
        var publisherOperator = document.querySelector('input[name="publisherOr"]').checked ? ' or ' : ' and ';
        var publishyears = [document.querySelector('input[name="yearfrom"]').value, document.querySelector('input[name="yearuntil"]').value];
        if (keywords[0] || authors[0] || publishers[0] || titles[0] || publishyears[0] || publishyears[1]) {
          let q = 'select ';
          let concat = false;
          {
            let op = '';
            for (let i = 0; i < select.length; i++) {
              if (i != yomiIndex) {
                q += op + '[' + select[i] + ']';
                if (!op) {op = ', ';}
              }
            }
          }
          q += ' where ';
          if (keywords[0]) {
            if (concat) {q += ' and ';}
            concat = true;
            let op = '';
            q += '(';
            for (let keyword of keywords) {
              q += op + '([' + select[titleIndices[0]] + '] contains "' + keyword + '" or ' +
                         '[' + select[titleIndices[1]] + '] contains "' + keyword + '" or ' +
                         '[' + select[authorIndices[0]] + '] contains "' + keyword + '" or ' + 
                         '[' + select[authorIndices[1]] + '] contains "' + keyword.replace(/[ぁ-ゖ]/g, (s) => {return String.fromCharCode(s.charCodeAt(0) + 0x60);}) + '" or ' +
                         '[' + select[publisherIndex] + '] contains "' + keyword + '")';
              if (!op) {op = keywordOperator;}
            }
            q += ')';
          }
          if (titles[0]) {
            if (concat) {q += ' and ';}
            concat = true;
            let op = '';
            q += '(';
            for (let title of titles) {
              q += op + '([' + select[titleIndices[0]] + '] contains "' + title + '" or ' +
                         '[' + select[titleIndices[1]] + '] contains "' + title + '")';
              if (!op) {op = titleOperator;}
            }
            q += ')';
          }
          if (authors[0]) {
            if (concat) {q += ' and ';}
            concat = true;
            let op = '';
            q += '(';
            for (let author of authors) {
              q += op + '([' + select[authorIndices[0]] + '] contains "' + author + '" or ' +
                         '[' + select[authorIndices[1]] + '] contains "' + author.replace(/[ぁ-ゖ]/g, (s) => {return String.fromCharCode(s.charCodeAt(0) + 0x60);}) + '")';
              if (!op) {op = authorOperator;}
            }
            q += ')';
          }
          if (publishers[0]) {
            if (concat) {q += ' and ';}
            concat = true;
            let op = '';
            q += '(';
            for (let publisher of publishers) {
              q += op + '[' + select[publisherIndex] + '] contains "' + publisher + '"';
              if (!op) {op = publisherOperator;}
            }
            q += ')';
          }
          if (publishyears[0] || publishyears[1]) {
            if (concat) {q += ' and ';}
            concat = true;
            q += '([' + select[publishyearIndex] + '] is not null and ';
            if (publishyears[0]) {
              q += '[' + select[publishyearIndex] + '] >= ' + publishyears[0];
              if (publishyears[1]) {
                q += ' and ';
              }
            }
            if (publishyears[1]) {
              q += '[' + select[publishyearIndex] + '] <= ' + publishyears[1];
            }
            q += ')';
          }

          // rewrite due to a bug of Google Visualization API
          for (let r of select) {
            q = q.replace(new RegExp('\\[' + r + '\\]', "g"), selectA1[r]);
          }

          document.getElementById('results').src = 'https://docs.google.com/spreadsheets/d/1-XgySBso-vJoqMhmYgUZMtjcCY0qnjm-vIr3c6J7_M8/gviz/tq?sheet=%22' + sheetname + '%22&tqx=out:html&tq=' + encodeURIComponent(q);
        }
        event.preventDefault();
      }
    </script>
  </body>
</html>
